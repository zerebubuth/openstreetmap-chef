#!/bin/bash

# Exit on error
set -e

# Get the name of the file and the expected pattern
file="$1"
pattern="^osm-([0-9]{4}-[0-9]{2}-[0-9]{2})\.dmp$"

# Give up now if the file isn't a database dump
[[ $file =~ $pattern ]] || exit 0

# Save the date from the file name
date="${BASH_REMATCH[1]}"

# Check the lock
if [ -f /tmp/planetdump.lock ]; then
    if [ "$(ps -p `cat /tmp/planetdump.lock` | wc -l)" -gt 1 ]; then
	echo "Error: Another planetdump is running"
	exit 1
    else
	rm /tmp/planetdump.lock
    fi
fi

# Create Lock
echo $$ > /tmp/planetdump.lock

function cleanup {
	 # Release lock
	 rm /tmp/planetdump.lock
}

# Remove lock on exit
trap cleanup EXIT

# Change to working directory
cd /store/planetdump

# Cleanup
rm -rf users
rm -rf changesets changeset_tags
rm -rf nodes node_tags
rm -rf ways way_tags way_nodes
rm -rf relations relation_tags relation_members

# Run the dump
time nice -n 19 /store/planet-dump-ng/planet-dump-ng \
     -c "pbzip2 -c" -f "${file}" --dense-nodes=1 \
     -C "changesets-${date}.osm.bz2" \
     -x "planet-${date}.osm.bz2" -X "history-${date}.osm.bz2" \
     -p "planet-${date}.osm.pbf" -P "history-${date}.osm.pbf"

# Move XML dumps into place
for file in "changesets-${date}.osm.bz2" "planet-${date}.osm.bz2" "history-${date}.osm.bz2"
do
    md5sum "#{file}" > "#{file}.md5"
    mv "${file}" "${file}.md5" "/store/planet/planet"
done

# Move PBF dumps into place
for file in "planet-${date}.osm.pbf" "history-${date}.osm.pbf"
do
    md5sum "#{file}" > "#{file}.md5"
    mv "${file}" "${file}.md5" "/store/planet/pbf"
done
